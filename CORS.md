---
type: note
status: done
tags: []
sources:
-
authors:
-
---
[[JavaScript Cross-Origin запросы]] | [Что такое CORS за 10 минут - YouTube](https://www.youtube.com/watch?v=meBaGIcOE2A)

### JavaScript в "песочнице" браузера

JavaScript-код, который вы получаете при загрузке сайта, выполняется в изолированной среде, которую называют "песочницей" (sandbox). У него нет прямого доступа к сетевым возможностям вашего компьютера.

> **Ключевая идея:** Любой сетевой запрос, который хочет сделать JavaScript-код со страницы, он должен **попросить сделать браузер**. Браузер выступает обязательным и строгим посредником.

Для этого в JavaScript существуют специальные инструменты (Web API), предоставляемые браузером:
1. **`fetch()` API:** Современный, мощный и гибкий способ делать HTTP-запросы.
2. **`XMLHttpRequest` (XHR):** Более старый, но все еще широко используемый объект для взаимодействия с серверами.

#### Главная угроза: автоматическая отправка Cookie

Когда вы логинитесь на каком-либо сайте (например, `https://мой-банк.рф`), этот сайт устанавливает в ваш браузер **cookie**. Этот cookie — как временный пропуск, который автоматически прикрепляется ко **всем** последующим запросам на `https://мой-банк.рф`, подтверждая, что это вы.

**В этом и заключается уязвимость:**
- Если JavaScript с вредоносного сайта `http://сайт-с-вирусом.рф` попросит браузер сделать `fetch`-запрос к `https://мой-банк.рф/api/balance`...
- ...браузер, по умолчанию, **автоматически прикрепит к этому запросу ваши cookie** от банка!

Для сервера банка этот запрос будет выглядеть абсолютно легитимным, как будто его отправили вы сами со страницы банка.

Именно для предотвращения подобных атак существует...

### Same-Origin Policy

По умолчанию для всех JavaScript и HTTP запросов действует правило:
- Браузер разрешает **fetch()** запросы к ресурсам только в том случае, если источник ресурсов и источник запроса совпадают:
	- **Ресурс считается принадлежащим другому источнику, если он расположен:**
		- на другом домене/поддомене
		- другом протоколе
		- другом порте
	- **Пример:** Представим, что ваш сайт (фронтенд) работает на `https://мой-сайт.рф:3000`. Запрос будет считаться кросс-доменным, если он идет к:
		- **Другому домену:** `https://чужой-сайт.рф:3000`
		- **Другому поддомену:** `https://api.мой-сайт.рф:3000`
		- **Другому протоколу:** `http://мой-сайт.рф:3000`
		- **Другому порту:** `https://мой-сайт.рф:8080`
- Все остальные запросы браузер блокирует 

### CORS (Cross-Origin Resource Sharing) 

- Механизм, который позволяет контролируемо обойти Same-Origin Policy
- Для этого сервер, к которому идет обращение, должен вернуть в ответе специальные **CORS-заголовки**. Браузер, увидев их, ослабляет защиту.

#### Основные CORS-заголовки:

1. **`Access-Control-Allow-Origin`**
 - **Описание:** Самый главный и обязательный заголовок. Он указывает, какому источнику (или источникам) разрешено получать доступ к ресурсу.
 - **Примеры использования:**
 - `Access-Control-Allow-Origin: https://my-frontend.com` — Строго разрешает доступ только вашему фронтенд-приложению.
 - `Access-Control-Allow-Origin: *` — Разрешает доступ любому источнику. **Потенциально опасно!** Используется только для полностью открытых, публичных API, которые не работают с чувствительными данными.

2. **`Access-Control-Allow-Methods`**
 - **Описание:** Указывает, какие HTTP-методы (`GET`, `POST`, `PUT`, `DELETE` и т.д.) разрешены для кросс-доменных запросов.
 - **Примеры использования:** Ваш API может разрешать всем читать данные (`GET`), но изменять их (`POST`, `PUT`) могут только доверенные источники. Пример: `Access-Control-Allow-Methods: GET, POST, OPTIONS`.

3. **`Access-Control-Allow-Headers`**
 - **Описание:** Указывает, какие HTTP-заголовки (помимо стандартных) клиент может отправлять в кросс-доменном запросе. Это критически важно для API, которые используют кастомные заголовки для аутентификации.
 - **Примеры использования:** Если ваш фронтенд отправляет токен аутентификации в заголовке `Authorization`, сервер *обязан* вернуть `Access-Control-Allow-Headers: Authorization`, чтобы браузер разрешил такой запрос.

4. **`Access-Control-Allow-Credentials`**
 - **Описание:** Этот заголовок (со значением `true`) разрешает браузеру отправлять cookie и другие учетные данные вместе с кросс-доменным запросом.
 - **Примеры использования:** Если вашему API для аутентификации нужны cookie, которые были установлены на его домене, без этого заголовка браузер просто не прикрепит их к запросу, и пользователь будет выглядеть как "неавторизованный". **Важно:** При использовании этого заголовка `Access-Control-Allow-Origin` не может быть `*`, нужно указывать конкретный домен.

### Когда нужно настраивать CORS на сервере?

Вы правы: CORS — это исключительно серверная настройка для тех API и ресурсов, к которым должен **напрямую обращаться JavaScript-код, работающий в браузере пользователя**, с другого источника.

- **НУЖНО настраивать CORS:**
 - **REST API для SPA:** Ваш бэкенд на `api.service.com`, а фронтенд (React, Vue, Angular) на `app.service.com`. Фронтенд делает `fetch`-запросы к бэкенду.
 - **Публичный API:** Вы создали API (например, погоды) и хотите, чтобы другие разработчики могли использовать его на своих сайтах.

- **НЕ НУЖНО настраивать CORS:**
 - **Внутренние микросервисы:** Сервис аутентификации, который общается только с другими вашими микросервисами внутри вашей сети. Браузер никогда не обращается к нему напрямую.
 - **База данных:** Фронтенд никогда не должен иметь прямого доступа к базе данных. Вся коммуникация идет через бэкенд-API.
